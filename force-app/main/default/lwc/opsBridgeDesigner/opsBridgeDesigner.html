<template>
    <div class="ops-bridge-designer">

        <!-- Header -->
        <div class="slds-page-header slds-page-header_record-home">
            <div class="slds-page-header__row">
                <div class="slds-page-header__col-title">
                    <div class="slds-media">
                        <div class="slds-media__figure">
                            <span class="slds-icon_container slds-icon-utility-flow">
                                <lightning-icon icon-name="utility:flow" alternative-text="OpsBridge" size="large"></lightning-icon>
                            </span>
                        </div>
                        <div class="slds-media__body">
                            <div class="slds-page-header__name">
                                <div class="slds-page-header__name-title">
                                    <h1>
                                        <span class="slds-page-header__title">OpsBridge Designer</span>
                                    </h1>
                                </div>
                            </div>
                            <p class="slds-page-header__name-meta">Visual DevOps Workflow Designer</p>
                        </div>
                    </div>
                </div>
                <div class="slds-page-header__col-actions">
                    <div class="slds-page-header__controls">
                        <div class="slds-page-header__control">
                            <lightning-button 
                                variant="neutral" 
                                label="Load Template" 
                                icon-name="utility:download"
                                onclick={handleOpenTemplateModal}>
                            </lightning-button>
                        </div>
                        <div class="slds-page-header__control">
                            <lightning-button 
                                variant="brand" 
                                label="View Monitor" 
                                icon-name="utility:monitor_loading"
                                onclick={handleViewMonitor}>
                            </lightning-button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="slds-grid slds-gutters slds-p-around_medium">

            <!-- LEFT COLUMN: Configuration & Action Library -->
            <div class="slds-col slds-size_1-of-4">
                <!-- Workflow Configuration -->
                <div class="slds-card slds-m-bottom_medium">
                    <div class="slds-card__header slds-grid">
                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                            <div class="slds-media__figure">
                                <lightning-icon icon-name="utility:settings" size="small"></lightning-icon>
                            </div>
                            <div class="slds-media__body">
                                <h2 class="slds-card__header-title">Workflow Configuration</h2>
                            </div>
                        </header>
                    </div>
                    <div class="slds-card__body slds-card__body_inner">
                        <lightning-input 
                            label="Workflow Name" 
                            value={workflowName} 
                            onchange={handleWorkflowNameChange}>
                        </lightning-input>

                        <lightning-textarea 
                            label="Description" 
                            value={workflowDescription} 
                            onchange={handleDescriptionChange}>
                        </lightning-textarea>

                        <lightning-combobox 
                            label="Trigger Type"
                            name="triggerType"
                            value={selectedTriggerType}
                            options={triggerTypeOptions}
                            onchange={handleTriggerTypeChange}>
                        </lightning-combobox>

                        <template if:true={isGitTrigger}>
                            <lightning-input 
                                type="url"
                                label="Repository URL" 
                                value={repositoryUrl} 
                                onchange={handleRepoUrlChange}>
                            </lightning-input>

                            <lightning-input 
                                type="text" 
                                label="Branch Pattern" 
                                value={branchPattern} 
                                onchange={handleBranchPatternChange}>
                            </lightning-input>
                        </template>

                        <lightning-button 
                            class="slds-m-top_medium"
                            variant="brand" 
                            label="Save Workflow" 
                            onclick={handleSaveWorkflow}>
                        </lightning-button>

                        <template if:true={selectedWorkflow}>
                            <lightning-button 
                                class="slds-m-top_small"
                                variant="success" 
                                label={executeButtonLabel}
                                onclick={handleExecuteWorkflow}
                                disabled={isExecuting}
                                icon-name="utility:play">
                            </lightning-button>
                        </template>
                    </div>
                </div>

                <!-- DevOps Action Library -->
                <div class="slds-card">
                    <div class="slds-card__header slds-grid">
                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                            <div class="slds-media__figure">
                                <lightning-icon icon-name="utility:apps" size="small"></lightning-icon>
                            </div>
                            <div class="slds-media__body">
                                <h2 class="slds-card__header-title">DevOps Action Library</h2>
                            </div>
                        </header>
                    </div>
                    <div class="slds-card__body slds-card__body_inner">
                        <template for:each={actionCategories} for:item="category">
                            <div key={category.name} class="slds-m-bottom_medium">
                                <h3 class="slds-text-heading_small slds-m-bottom_small">{category.name}</h3>
                                <template for:each={category.actions} for:item="action">
                                    <div key={action.id}
                                         class="slds-box slds-theme_default slds-m-bottom_x-small"
                                         data-action-id={action.id}
                                         draggable="true"
                                         ondragstart={handleDragStart}
                                         ondragend={handleDragEnd}>
                                        <strong>{action.title}</strong>
                                        <p>{action.description}</p>
                                        <p class="slds-text-color_weak">{action.connector}</p>
                                        <lightning-icon icon-name="utility:drag_and_drop" size="x-small"></lightning-icon>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
                <!-- Saved Workflows -->
                <template if:true={hasSavedWorkflows}>
                    <div class="slds-card slds-m-top_medium">
                        <div class="slds-card__header slds-grid">
                            <header class="slds-media slds-media_center slds-has-flexi-truncate">
                                <div class="slds-media__figure">
                                    <lightning-icon icon-name="utility:save" size="small"></lightning-icon>
                                </div>
                                <div class="slds-media__body">
                                    <h2 class="slds-card__header-title">Saved Workflows</h2>
                                </div>
                            </header>
                        </div>
                        <div class="slds-card__body slds-card__body_inner">
                            <template for:each={savedWorkflows} for:item="workflow">
                                <div key={workflow.Id} 
                                     class="saved-workflow-item slds-box slds-m-bottom_x-small"
                                     data-workflow-id={workflow.Id}
                                     onclick={handleLoadWorkflow}>
                                    {workflow.Name}
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
            <!-- RIGHT COLUMN: Drag-and-Drop Canvas -->
            <div class="slds-col slds-size_2-of-3">
                <div class="workflow-canvas"
                     ondragover={handleDragOver}
                     ondragleave={handleDragLeave}
                     ondrop={handleDrop}>
                    <h3>Workflow Canvas</h3>
                    <template if:true={workflowSteps}>
                        <template for:each={workflowSteps} for:item="step">
                            <div key={step.id} class="workflow-step">
                                <strong>{step.icon} {step.title}</strong>
                                <div>{step.description}</div>
                                <div>{step.connector}</div>
                            </div>
                        </template>
                    </template>
                </div>
            </div>
        </div>
        
    </div>
</template>
